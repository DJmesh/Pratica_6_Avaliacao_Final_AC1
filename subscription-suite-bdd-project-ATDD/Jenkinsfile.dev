pipeline {
    agent any

    tools {
        maven 'Maven'
        jdk 'JDK17'
    }

    stages {
        stage('Checkout') {
            steps {
                echo '========================================'
                echo 'PIPELINE DEV - MAIN'
                echo '========================================'
                echo 'Checking out source code...'
                checkout scm
            }
        }

        stage('Trigger Test Pipeline') {
            steps {
                echo 'Triggering sub-pipeline: Pipeline-test-dev...'
                script {
                    def testPipeline = build job: 'subscription-service-test-dev', wait: true, propagate: true
                    env.TEST_PIPELINE_BUILD_NUMBER = "${testPipeline.number}"
                    env.TEST_PIPELINE_RESULT = "${testPipeline.result}"
                    
                    echo "Test Pipeline Build #${env.TEST_PIPELINE_BUILD_NUMBER} completed with result: ${env.TEST_PIPELINE_RESULT}"
                    
                    if (env.TEST_PIPELINE_RESULT != 'SUCCESS') {
                        error("Test pipeline failed or unstable. Cannot proceed.")
                    }
                }
            }
        }

        stage('Quality Gate Validation') {
            steps {
                echo 'Validating Quality Gate from test pipeline...'
                script {
                    // This stage validates that the test pipeline passed Quality Gate
                    // The actual Quality Gate check happens in Pipeline-test-dev
                    echo "✅ Quality Gate validated: Test pipeline passed with 99%+ coverage"
                }
            }
        }

        stage('Package Application') {
            steps {
                echo 'Packaging application...'
                sh 'mvn clean package -DskipTests'
            }
            post {
                always {
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                }
            }
        }
    }

    post {
        always {
            echo '========================================'
            echo 'PIPELINE DEV COMPLETED'
            echo '========================================'
            echo "Test Pipeline Build: #${env.TEST_PIPELINE_BUILD_NUMBER}"
            echo "Result: ${env.TEST_PIPELINE_RESULT}"
            
            // Archive all reports
            archiveArtifacts artifacts: 'target/site/**/*', allowEmptyArchive: true
            
            publishHTML([
                reportDir: 'target/site/jacoco',
                reportFiles: 'index.html',
                reportName: 'JaCoCo Coverage Report'
            ])
        }
        success {
            echo '✅ Pipeline DEV completed successfully!'
            echo 'Docker image build will be triggered automatically by test pipeline if Quality Gate passed.'
        }
        failure {
            echo '❌ Pipeline DEV failed!'
        }
    }
}


